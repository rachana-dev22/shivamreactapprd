import{WorkerEntrypoint as T}from"cloudflare:workers";var i=class{data;constructor(e){this.data=e}async get(e){let n=await g(e),s=p(new Uint8Array(this.data,20),n);return s?S(s):null}},g=async t=>{let n=new TextEncoder().encode(t),s=await crypto.subtle.digest("SHA-256",n.buffer);return new Uint8Array(s,0,16)},p=(t,e)=>{if(t.byteLength===0)return!1;let n=t.byteOffset+(t.byteLength/40>>1)*40,s=new Uint8Array(t.buffer,n,16);if(s.byteLength!==e.byteLength)throw new TypeError("Search value and current value are of different lengths");let r=H(e,s);if(r<0){let o=t.byteOffset,a=n-t.byteOffset;return p(new Uint8Array(t.buffer,o,a),e)}else if(r>0){let o=n+40,a=t.buffer.byteLength-n-40;return p(new Uint8Array(t.buffer,o,a),e)}else return new Uint8Array(t.buffer,n,40)},H=(t,e)=>{if(t.byteLength<e.byteLength)return-1;if(t.byteLength>e.byteLength)return 1;for(let[n,s]of t.entries()){if(s<e[n])return-1;if(s>e[n])return 1}return 0},S=t=>[...new Uint8Array(t,t.byteOffset+16).slice(0,16)].map(n=>n.toString(16).padStart(2,"0")).join("");var c=class extends Response{constructor(e,n){super(e,{...n,status:200})}},u=class extends Response{constructor(...[e,n]){super(e,{...n,status:404,statusText:"Not Found"})}},f=class extends Response{constructor(...[e,n]){super(e,{...n,status:405,statusText:"Method Not Allowed"})}},d=class extends Response{constructor(e,n){super(void 0,{...n,status:500})}};var h="public, max-age=0, must-revalidate";function y(t,e){let n=new Headers(t);for(let[s,r]of e)n.set(s,r);return n}function A(t,e,n){let s=e?.contentType??"application/octet-stream";s.startsWith("text/")&&!s.includes("charset")&&(s=`${s}; charset=utf-8`);let r=new Headers({"Access-Control-Allow-Origin":"*","Content-Type":s,"Referrer-Policy":"strict-origin-when-cross-origin","X-Content-Type-Options":"nosniff",ETag:`${t}`});return m(n)&&r.append("Cache-Control",h),r}function m(t){return!t.headers.has("authorization")&&!t.headers.has("range")}async function E(t,e,n=1){let s=0;for(;s<=n;)try{return await t.getWithMetadata(e,{type:"stream",cacheTtl:31536e3})}catch{if(s>=n)throw new Error(`Requested asset ${e} could not be fetched from KV namespace.`);await new Promise(o=>setTimeout(o,Math.pow(2,s++)*1e3))}}var l=class extends T{async fetch(t){if(t.method.toLowerCase()!=="get")return new f;try{return this.handleRequest(t)}catch(e){return new d(e)}}async handleRequest(t){let e=await this.getAssetEntry(t);if(!e)return new u;let n=await E(this.env.ASSETS_KV_NAMESPACE,e);if(!n||!n.value)throw new Error(`Requested asset ${e} exists in the asset manifest but not in the KV namespace.`);let{value:s,metadata:r}=n,o=A(e,r,t),a=y(t.headers,o);return new c(s,{headers:a})}async getAssetEntry(t){let e=new URL(t.url),{pathname:n}=e,s=new i(this.env.ASSETS_MANIFEST);return n=globalThis.decodeURIComponent(n),await s.get(n)}};export{l as default};
